<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Vision AI - Professional Dental Analysis System</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #root {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        #ComposeTarget {
            width: 100%;
            height: 100%;
            display: block;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: #ffffff;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066CC;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 20px;
            color: #0066CC;
            font-size: 16px;
            font-weight: 500;
        }
        .error-box {
            margin-top: 20px;
            padding: 20px;
            background-color: #ffebee;
            border: 1px solid #ef5350;
            border-radius: 8px;
            max-width: 600px;
            display: none;
        }
        .error-title {
            color: #c62828;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .error-hint {
            color: #666;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Dental Vision AI...</div>
        <div class="error-box" id="error-box">
            <div class="error-title">Error Loading Application</div>
            <div class="error-message" id="error-message"></div>
            <div class="error-hint">Press F12 and check Console tab for detailed error logs</div>
        </div>
    </div>
    <script type="importmap">
    {
        "imports": {
            "@js-joda/core": "https://cdn.jsdelivr.net/npm/@js-joda/core@5.6.3/dist/js-joda.esm.js"
        }
    }
    </script>
    <script type="module">
        console.log('[WASM] Starting application load...');
        console.log('[WASM] Current URL:', window.location.href);
        console.log('[WASM] Module path: DentalVisionAI-composeApp-wasm-js.mjs');

        const loadingText = document.querySelector('.loading-text');
        const spinner = document.querySelector('.spinner');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        let loadTimeout;

        function showError(error) {
            console.error('[WASM] Fatal error:', error);
            spinner.style.display = 'none';
            loadingText.textContent = 'Application Failed to Load';
            loadingText.style.color = '#c62828';
            errorBox.style.display = 'block';

            // Safely extract error information
            const errorName = error?.name || 'Error';
            const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
            errorMessage.textContent = `${errorName}: ${errorMsg}\n\nStack trace available in Console (F12)`;

            if (error?.stack) {
                console.error('[WASM] Stack trace:', error.stack);
            }

            clearTimeout(loadTimeout);
        }

        loadTimeout = setTimeout(() => {
            console.warn('[WASM] Loading is taking longer than expected (30s). This might indicate an issue.');
            loadingText.textContent = 'Loading is taking longer than expected...';
            loadingText.style.color = '#f57c00';
        }, 30000);

        console.log('[WASM] Attempting to import main module...');

        import('./DentalVisionAI-composeApp-wasm-js.mjs')
            .then((module) => {
                console.log('[WASM] Module imported successfully');
                console.log('[WASM] Module exports:', Object.keys(module));
                clearTimeout(loadTimeout);

                // Kotlin WASM auto-initializes main() on import
                // Just wait a bit for rendering to complete
                console.log('[WASM] Application initialized automatically');

                setTimeout(() => {
                    console.log('[WASM] Hiding loading screen');
                    document.getElementById('loading').style.display = 'none';
                }, 1000);
            })
            .catch(error => {
                showError(error);

                // Safely check error message (handle undefined/null)
                const errorMsg = error?.message || error?.toString() || 'Unknown error';
                if (errorMsg.includes('@js-joda')) {
                    console.error('[WASM] js-joda module error detected');
                    console.error('[WASM] This is a known issue with kotlinx-datetime in WASM');
                    console.error('[WASM] Possible solutions:');
                    console.error('[WASM]   1. Use Desktop target instead');
                    console.error('[WASM]   2. Replace kotlinx-datetime with platform-specific date handling');
                    errorMessage.textContent =
                        'WASM Module Error: kotlinx-datetime compatibility issue\n\n' +
                        'This is a known limitation with WASM target.\n' +
                        'Please use Desktop version for full functionality.\n\n' +
                        'Technical: ' + errorMsg;
                }
            });

        window.addEventListener('error', (event) => {
            console.error('[WASM] Global error caught:', event.error);
            showError(event.error || new Error(event.message));
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('[WASM] Unhandled promise rejection:', event.reason);
            showError(event.reason || new Error('Unhandled promise rejection'));
        });
    </script>
</body>
</html>
